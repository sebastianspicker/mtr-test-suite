name: ci

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Shell + PowerShell lint
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Cache CI tools
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .ci-tools
          key: ci-tools-${{ runner.os }}-shellcheck-0.9.0-shfmt-3.7.0

      - name: Install pinned tools
        run: |
          set -euo pipefail
          scripts/ci-install-tools.sh

      - name: Add tools to PATH
        run: echo "${{ github.workspace }}/.ci-tools" >> "$GITHUB_PATH"

      - name: Shell validation
        run: |
          set -euo pipefail
          mkdir -p ci-artifacts
          make validate 2>&1 | tee ci-artifacts/shell-validate.log

      - name: Dry-run smoke test
        run: |
          set -euo pipefail
          mkdir -p ci-artifacts
          ./mtr-test-suite.sh --dry-run --no-summary 2>&1 | tee ci-artifacts/dry-run.log

      - name: PowerShell static analysis
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path ci-artifacts | Out-Null
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
          Invoke-ScriptAnalyzer -Path NetTestSuite.ps1 -Severity Error -EnableExit | Tee-Object -FilePath ci-artifacts/psscriptanalyzer.log

      - name: Upload CI artifacts on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-artifacts-${{ github.job }}
          path: ci-artifacts
          if-no-files-found: ignore

  secret_scan:
    name: Secret scan
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Gitleaks secret scan
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        with:
          args: --no-git --redact

  dependency_review:
    name: Dependency review (PR only)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
